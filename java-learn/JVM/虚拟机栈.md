# 虚拟机栈
虚拟机栈中有两种常见的[[抽象数据结构]](ADT): 栈和堆
栈是**运行时**的数据结构,解决的是程序如何执行,数据该如何处理的问题
堆是**存储时**的数据结构,解决的是数据放在哪里,怎么放的问题

### 概述
每一个线程对应一个虚拟机栈
虚拟机栈的生命周期和线程相同,线程被销毁后,虚拟机栈也被销毁.
虚拟机栈由**栈帧**组成,每个栈帧对应一个Java方法的调用

虚拟机栈只接受两种操作: 出栈和入栈 (因此虚拟机栈没有什么优化空间,GC并不会对虚拟机栈进行垃圾回收)

虚拟机栈的访问速度是很快的,仅次于程序计数器.

可以对vm做`-Xss`配置更改虚拟机栈的大小
![[Pasted image 20220322163409.png]]
![[Pasted image 20220322163404.png]]

### 栈帧
在一个活跃的线程中,在某一个特定的时间点上,只会有一个活动的**栈帧**,称之为**当前栈帧**,对应方法是**当前方法**,对应类是**当前类**.
执行引擎只针对当前栈帧进行操作
如果当前方法调用了其他方法,则新的栈帧就会被创建出来,称为新的栈帧

### 运行中的栈帧
不同线程的栈帧是不能相互引用的

若有方法A调用了方法B,在方法B返回之际,会把方法B的返回结果传递给方法A对应的栈帧,接着方法B的栈帧就会被销毁,使得方法A的栈帧成为当前栈帧.

### 栈的内部结构
栈的内部可以划分成六块:`局部变量表`,`操作数栈`,`动态链接`,`方法返回地址`,`方法的调用`,`附加信息`
#### 局部变量表
- 局部变量表表现为一个数组,有索引,和索引对应的值.
- 局部变量表中只存放**8种基本数据类型**,**对象引用**(而不是对象本身,是对象的地址),**返回的地址**
- 局部变量表是在虚拟机栈中的,这意味着它是每个线程占一份的,不存在数据共享,因此是线程安全的.
- 局部变量表的大小是在编译期间确定下来的
- 局部变量表最基本的单位是slot,其中一个slot占32位,double和float类型的数据占用两个slot,其他基本数据类型只占用1个slot
![[Pasted image 20220322165504.png]]
如果当前帧是由构造方法或者实例方法创建的，那么该对象引用this，会存放在index为0的slot处，其余的参数表顺序继续排列. 
如果当前帧是静态方法创建的,则不会有this,也就又不会有上图中关于this的slot
slot是可以重复使用的,如果一个局部变量过了它的作用域,它所占用的slot就会被标记为空,之后的其他变量可以利用这个slot
- 局部变量表与当前方法的生命周期相同,当方法调用结束后,会随之销毁
**垃圾回收**
被局部变量引用的数据和对象都不会被垃圾回收
#### 操作数栈

#### 动态链接
#### 方法返回地址
#### 方法的调用
#### 附加信息

