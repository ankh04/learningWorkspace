## 什么是运行时存储空间?
程序运行时的数据需要进行有效的组织, 具体来说, 可能需要满足:
- 对于局部变量, 在需要的时候进行创建, 在不需要时进行回收
- 不同过程(函数/方法)之间对于变量的引用需要明确

## 在设计运行时存储空间时需要考虑哪些问题?
- 过程(函数/方法)是否允许嵌套
- 过程是否可以作为参数传递(函数式编程)
- 存储空间是否可以动态分配
- 存储空间是否需要显示释放


## 存储分配有哪两种策略? 分别有什么特点?
- 静态分配策略
	- 在编译时确定数据空间大小, 并为每个数据项确定运行时空间的位置
	- **代表语言:** FORTRAN
- 动态分配策略
	- 在编译时不能确定数据空间大小
	- 允许递归过程
	- 允许栈式分配内存, 堆式分配内存
	- **代表语言:** PASCAL C/C++

## 程序在运行时的内存分配是什么样的? 局部变量是分配在哪部分的?
内存分配如下图所示
![](https://picture-bed-1301848969.cos.ap-shanghai.myqcloud.com/20220616202336.png)

局部变量/形式变量/临时工作单元作为**活动记录**存放在==栈==中

## 活动记录是什么? 活动记录包括哪些内容?
活动记录是调用一个过程时往栈中存放的存储空间

如果是**非嵌套过程**, 一个活动记录会是下面的样子:
![](https://picture-bed-1301848969.cos.ap-shanghai.myqcloud.com/20220616205211.png)

如果编程语言允许嵌套过程, 即允许在过程中定义过程, 就会出现稍复杂的活动记录, 我们称为**嵌套过程活动记录**

## 嵌套过程如何访问外部的变量? 什么是闭包?
如果需要在嵌套过程中访问外部的变量, 需要更复杂的活动记录, 有两种实现方法:
- 静态链
- 嵌套层次显示表

==静态链==
会在活动记录中预留*一个位*用来存放*上一层*的SP位置

==嵌套层次显示表==
会在活动记录中开辟*一块空间*, 用来存放上一层中层数数量的SP位置

==闭包==
在JavaScript中, 闭包就是可以在内层函数访问其外层函数作用域的能力.
也就是在嵌套过程中访问外部变量的能力.
需要注意的是, JavaScript 可以把函数作为参数返回, 在这种情况下闭包会有很有趣的性质:
**如果一个函数作为返回值被返回, 这个函数引用的外层函数作用域也会被保存**
可以利用上述性质达到与Java语言类似的"私有变量"效果
```JavaScript
function create_counter(initial) {
    var x = initial || 0;
    return {
        inc: function () {
            x += 1;
            return x;
        }
    }
}

var c1 = create_counter();
c1.inc(); // 1
c1.inc(); // 2
c1.inc(); // 3

var c2 = create_counter(10);
c2.inc(); // 11
c2.inc(); // 12
c2.inc(); // 13
```

```ad-note
注意这里被保存的外层函数作用域是唯一的(参考下面的例子)
```
```JavaScript
function count() {
    var arr = [];
    for (var i=1; i<=3; i++) {
        arr.push(function () {
            return i * i;
        });
    }
    return arr;
}

var results = count();
var f1 = results[0]; // 16 (此时i已经是4了)
var f2 = results[1]; // 16
var f3 = results[2]; // 16
```

关于闭包更详细的介绍在[这里](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures)

